<project basedir="." default="clean">

	<property name="service.repos.dir" value="build/service_repositories"/>
	<property name="client.repos.dir" value="build/client_repositories"/>
	<property name="temp.dir" value="build/temp"/>
	<property name="temp.client.dir" value="build/temp_client"/>
	
	<property name="modules.dir" value="modules"/>
	<property name="lib.dir" value="lib"/>

	<property name="addressing.mar" value="addressing-SNAPSHOT.mar"/>
	<property name="rampart.mar" value="rampart-SNAPSHOT.mar"/>	
	
	<property name="client.port" value="9080"/>
	<property name="server.port" value="8080"/>
	
	<property name="sample.services.url" value="http://localhost:${client.port}/axis2/services"/>
	
	<target name="check.dependency" unless="env.AXIS2_HOME">
        <echo message="AXIS2_HOME must be set"/>
    </target>
	
	<!-- Sample Service 01 -->
	<target name="service.01">
		<create.service.repo sample.number="01"/>
	</target>

	<!-- Sample Client 01 -->
	<target name="client.01">
		<create.and.run.client sample.number="01"/>
	</target>
	
	<!-- Sample Service 02 -->
	<target name="service.02">
		<create.service.repo sample.number="02"/>
	</target>

	<!-- Sample Client 01 -->
	<target name="client.02">
		<create.and.run.client sample.number="02"/>
	</target>

	<!-- Sample Service 03 -->
	<target name="service.03">
		<create.service.repo sample.number="03"/>
	</target>

	<!-- Sample Client 01 -->
	<target name="client.03">
		<create.and.run.client sample.number="03"/>
	</target>

	<!-- Sample Service 04 -->
	<target name="service.04">
		<create.service.repo sample.number="04"/>
	</target>

	<!-- Sample Client 04 -->
	<target name="client.04">
		<create.and.run.client sample.number="04"/>
	</target>

	<!-- Sample Service 05 -->
	<target name="service.05">
		<create.service.repo sample.number="05"/>
	</target>

	<!-- Sample Client 05 -->
	<target name="client.05">
		<create.and.run.client sample.number="05"/>
	</target>
	
	<!-- Sample Service 06 -->
	<target name="service.06">
		<create.service.repo sample.number="06"/>
	</target>

	<!-- Sample Client 06 -->
	<target name="client.06">
		<create.and.run.client sample.number="06"/>
	</target>
	
	<!-- Sample Service 07 -->
	<target name="service.07">
		<create.service.repo sample.number="07"/>
	</target>

	<!-- Sample Client 07 -->
	<target name="client.07">
		<create.and.run.client sample.number="07"/>
	</target>

	<!-- Sample Service 08 -->
	<target name="service.08">
		<create.service.repo sample.number="08"/>
	</target>

	<!-- Sample Client 08 -->
	<target name="client.08">
		<create.and.run.client sample.number="08"/>
	</target>

	<!-- Sample Service 09 -->
	<target name="service.09">
		<create.service.repo sample.number="09"/>
	</target>

	<!-- Sample Client 09 -->
	<target name="client.09">
		<create.and.run.client sample.number="09"/>
	</target>

	<!-- Sample Service 10 -->
	<target name="service.10">
		<create.service.repo sample.number="10"/>
	</target>

	<!-- Sample Client 10 -->
	<target name="client.10">
		<create.and.run.client sample.number="10"/>
	</target>
	
	<!-- Sample Service 11 -->
	<target name="service.11">
		<create.service.repo sample.number="11"/>
	</target>

	<!-- Sample Client 11 -->
	<target name="client.11">
		<create.and.run.client sample.number="11"/>
	</target>
	
	
	<target name="clean">
		<delete dir="build" />
	</target>
	
	<!-- Macro to create a service repo for a given sample -->
	<macrodef name="create.service.repo">
	   	<attribute name="sample.number" default="sample"/>
	   	<sequential>
	   		<mkdir dir="${service.repos.dir}/sample@{sample.number}"/>
	   		<mkdir dir="${service.repos.dir}/sample@{sample.number}/services"/>
	   		<mkdir dir="${service.repos.dir}/sample@{sample.number}/modules"/>
	   		
	   		<!-- copy modules -->
	   		<copy file="${modules.dir}/${addressing.mar}" tofile="${service.repos.dir}/sample@{sample.number}/modules/${addressing.mar}" overwrite="true"/>
	   		<copy file="${modules.dir}/${rampart.mar}" tofile="${service.repos.dir}/sample@{sample.number}/modules/${rampart.mar}" overwrite="true"/>
	   		
	   		<!-- create service -->
	   		<mkdir dir="${temp.dir}"/>
	   		<mkdir dir="${temp.dir}/META-INF"/>
	   		
	   		<!-- Compile service -->
            <javac srcdir="sample@{sample.number}/src" destdir="${temp.dir}">
                    <classpath>
                            <fileset dir="lib">
                                    <include name="**/*.jar"/>
                            </fileset>
                    </classpath>
                    <exclude name="**/Client.java"/>
            </javac>
	   		
	   		<copy file="sample@{sample.number}/services.xml" tofile="${temp.dir}/META-INF/services.xml" overwrite="true"/>
	   		<copy file="keys/service.jks" tofile="${temp.dir}/service.jks" overwrite="true"/>
	   		<copy file="keys/service.properties" tofile="${temp.dir}/service.properties" overwrite="true"/>

	   		<jar destfile="${service.repos.dir}/sample@{sample.number}/services/sample@{sample.number}.aar">
				<fileset dir="${temp.dir}"></fileset>
			</jar>
	   		
			<delete dir="${temp.dir}" />
	   		<!-- start SimpleHTTPserver -->
            <java classname="org.apache.axis2.transport.http.SimpleHTTPServer" fork="true">
                    <arg value="${service.repos.dir}/sample@{sample.number}"/>
                    <arg value="-p${server.port}"/>
                    <classpath>
                            <fileset dir="lib">
                                    <include name="**/*.jar"/>
                            </fileset>
                    </classpath>
            </java>

	   </sequential>
	</macrodef>

	<macrodef name="create.and.run.client">
	   	<attribute name="sample.number" default="sample"/>
	   	<sequential>
	   		<!-- Create the client repo -->
	   		<mkdir dir="${client.repos.dir}/sample@{sample.number}"/>
	   		<mkdir dir="${client.repos.dir}/sample@{sample.number}/conf"/>
	   		<mkdir dir="${client.repos.dir}/sample@{sample.number}/modules"/>
	   		
	   		<!-- Copy axis2.xml file -->
	   		<copy file="sample@{sample.number}/client.axis2.xml" tofile="${client.repos.dir}/sample@{sample.number}/conf/axis2.xml" overwrite="true"/>
	   		
	   		<!-- copy modules -->
	   		<copy file="${modules.dir}/${addressing.mar}" tofile="${client.repos.dir}/sample@{sample.number}/modules/${addressing.mar}" overwrite="true"/>
	   		<copy file="${modules.dir}/${rampart.mar}" tofile="${client.repos.dir}/sample@{sample.number}/modules/${rampart.mar}" overwrite="true"/>
	   		
	   		<mkdir dir="${temp.client.dir}"/>
	   		
	   		<!-- Compile client -->
            <javac srcdir="sample@{sample.number}/src" destdir="${temp.client.dir}">
                    <classpath>
	                    <fileset dir="lib">
                            <include name="**/*.jar"/>
	                    </fileset>
                    </classpath>
                    <exclude name="**/SimpleService.java"/>
            </javac>

	   		<copy file="keys/client.jks" tofile="${temp.client.dir}/client.jks" overwrite="true"/>
	   		<copy file="keys/client.properties" tofile="${temp.client.dir}/client.properties" overwrite="true"/>

	   		
	   		<!-- Run client -->
            <java classname="org.apache.rampart.samples.sample@{sample.number}.Client" fork="true">
                    <arg value="${sample.services.url}/sample@{sample.number}"/>
                    <arg value="${client.repos.dir}/sample@{sample.number}"/>
                    <classpath>
                        <fileset dir="lib">
                        	<include name="**/*.jar"/>
                        </fileset>
                  		<dirset dir="${temp.client.dir}" />
                    </classpath>
            </java>

<!--	   		<delete dir="${temp.client.dir}"/> -->
		</sequential>		
	</macrodef>

</project>