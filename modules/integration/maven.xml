<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Licensed to the Apache Software Foundation (ASF) under one
  ~ or more contributor license agreements. See the NOTICE file
  ~ distributed with this work for additional information
  ~ regarding copyright ownership. The ASF licenses this file
  ~ to you under the Apache License, Version 2.0 (the
  ~ "License"); you may not use this file except in compliance
  ~ with the License. You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing,
  ~ software distributed under the License is distributed on an
  ~ "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
  ~ KIND, either express or implied. See the License for the
  ~ specific language governing permissions and limitations
  ~ under the License.
  -->
<project default="jar"
         xmlns:j="jelly:core"
         xmlns:u="jelly:util"
         xmlns:maven="jelly:maven"	
         xmlns:deploy="deploy"
         xmlns:ant="jelly:ant">
    <j:set var="samples.dir" value="target/samples"/>

    <preGoal name="test:compile">

		<!-- Set a property that can be picked up from the ant build.xml's -->
		<ant:property name="maven.class.path" refid="maven.dependency.classpath"/>

		<!-- copy the mars so that they are available on the test classpath -->
		<copy file="../addressing/target/addressing-${addressing_version}.mar"
			  tofile="target/test-classes/modules/addressing-${addressing_version}.mar"/>
		
		<j:set var="axis2.home" value="${basedir}/target"/>

        <!-- compiling some custom wsdl files -->
        <j:set var="wsdl.source.dir" value="test-resources/wsdl"/>
        <j:set var="wsdl.output.base.dir" value="target/wsdl"/>
        <!-- make the dirs -->
        <mkdir dir="${wsdl.output.base.dir}"/>

        <ant:echo>Compiling ComplexDataTypes.wsdl</ant:echo>
        <mkdir dir="${wsdl.output.base.dir}/complexdatatype"/>
        <java classname="org.apache.axis2.wsdl.WSDL2Java" fork="true">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <arg line="-o target/wsdl/complexdatatype -ap -s -u -uw -uri test-resources/ComplexDataTypes/ComplexDataTypes.wsdl"/>
        </java>
        <javac destdir="target/classes" debug="on">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <src path="target/wsdl/complexdatatype"/>
        </javac>

          
        <ant:echo>Compiling ComplexDataTypesDocLitBare.wsdl</ant:echo>
        <mkdir dir="${wsdl.output.base.dir}/complexdatatypebare"/>
        <java classname="org.apache.axis2.wsdl.WSDL2Java" fork="true">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <arg line="-o target/wsdl/complexdatatypebare -s -uri test-resources/ComplexDataTypesDocLitBare/ComplexDataTypesDocLitBare.wsdl"/>
        </java>
        <javac destdir="target/classes" debug="on">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <src path="target/wsdl/complexdatatypebare"/>
        </javac>



        <ant:echo>Compiling DocumentUnwrappingTest.wsdl </ant:echo>
        <mkdir dir="${wsdl.output.base.dir}/documentunwrapping"/>
        <java classname="org.apache.axis2.wsdl.WSDL2Java" fork="true">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <arg line="-o target/wsdl/documentunwrapping -ap -ss -sd -ssi -u  -g -uw -uri test-resources/wsdl/DocumentUnwrappingTest.wsdl"/>
        </java>
        <ant:ant antfile="build.xml" inheritall="true" inheritrefs="true" dir="target/wsdl/documentunwrapping"/>

    	
        <ant:echo>Compiling RPCUnwrappingTest.wsdl </ant:echo>
        <mkdir dir="${wsdl.output.base.dir}/rpcunwrapping"/>
        <java classname="org.apache.axis2.wsdl.WSDL2Java" fork="true">
            <jvmarg line="${maven.junit.jvmargs}"/>
            <classpath refid="maven.dependency.classpath"/>
            <classpath location="${compiled.classes.dir}"/>
            <arg line="-o target/wsdl/rpcunwrapping -ap -ss -sd -ssi -u  -g -uw -uri test-resources/wsdl/RPCUnwrappingTest.wsdl"/>
        </java>
        <ant:ant antfile="build.xml" inheritall="true" inheritrefs="true" dir="target/wsdl/rpcunwrapping"/>

		<!-- compile the schema for XMLbeans -->
		<java classname="org.apache.xmlbeans.impl.tool.SchemaCompiler" fork="true">
			<classpath refid="maven.dependency.classpath"/>
			<arg line="-src target/xmlbeans-src -d target/classes test-resources/xsd/type-test.xsd"/>
		</java>
	  
		<j:if test="${context.getVariable('skip.enterprise.tests') != 'true'}">	
			<ant:ant antfile="itest-build.xml" inheritall="true" inheritrefs="true"
				dir="." target="rpc-wsdl-codegen"/>
			<j:if test="${context.getVariable('maven.test.skip') != 'true'}">
				<ant:ant antfile="itest-build.xml" inheritall="true" inheritrefs="true"
					dir="." target="enterprise-wsdl-codegen"/>
				
            </j:if>
			<ant:ant antfile="itest-build.xml" inheritall="true" inheritrefs="true"
				dir="." target="build-soap12-services"/>
        </j:if>
    </preGoal>

    <postGoal name="test:compile">
        <j:if test="${context.getVariable('maven.test.skip') != 'true'}">
        	<ant:ant antfile="itest-build.xml" inheritall="true" inheritrefs="true"
        	                         dir="." target="build-repos"/>
        </j:if>
    </postGoal>
</project>
